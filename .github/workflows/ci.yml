name: CI
'on':
  push:
    branches:
      - main
      - v0/**
      - poc/**
  pull_request:
    branches:
      - main
jobs:
  dependency_gcc:
    runs-on: ubuntu-latest
    outputs:
      RUNNER: ${{ runner.name }}
    steps:
      # - name: Configure Git for GitLab
      #   run: |
      #     git config --global user.username bencs
      #     git config --global user.password "${{ secrets.PAT_GITLAB }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: '${{ secrets.PAT_TOKEN }}'

      - name: Clone GitLab submodule
        run: |
            git config --global credential.helper '!f() { echo "username='${{secrets.USER_GITLAB}}';password=`${{secrets.PAT_GITLAB }}`"; }; f'
            git submodule update --init --recursive

 

      - name: Setup Cpp (C++ / C)
        uses: aminya/setup-cpp@v0.37.0
        with:
          compiler: gcc
          ninja: true
          meson: false
          python: true
          make: false
          doxygen: false
      

      - name: OMP / MPI / Dependencies
        run: sudo apt-get install -y libomp-dev libopenmpi-dev python3-pybind11 libeigen3-dev python3-pip
      - name: Install Python Development Packages
        run:  sudo apt-get install -y python3-dev
      - name: Install Meson 
        run: pip3 install meson
      - name: Install Pybind11
        run: 'pip install "pybind11[global]"'
      - name: Configure and build project
        run: |
          mkdir builddir
          meson setup builddir/ --buildtype=release
          meson compile -C builddir
      - name: Run unit tests
        run: |
          cd builddir
          meson test
