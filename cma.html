<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BioCMAMC-ST: Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BioCMAMC-ST
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search',true);
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('cma.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
Compartment Modelling Approach</h1>
<p>Instead of directly solving hydrodynamics equations, this tool utilizes pre-computed flow fields sourced from various origins and aggregated into a unified compartment formalism.</p>
<p>A compartment represents a coarse mesh element that contains a small volume of fluid or gas where conditions are considered homogeneous. Values are integrated over each volume, preserving spatial heterogeneity while simplifying computations. Both liquid and gas phases are treated as Eulerian scalars transported between compartments using flow field data.</p>
<p>For discrete particles, transport is also based on flow fields but incorporates stochastic methods to handle their movement through the domain.</p>
<p>This documentation focuses on the namespace <a class="el" href="namespaceCmaUtils.html">CmaUtils</a> and the functor <a class="el" href="structSimulation_1_1KernelInline_1_1MoveFunctor.html">MoveFunctor</a>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
CmaUtils</h2>
<p>The <b><a class="el" href="namespaceCmaUtils.html" title="Namespace to handle algorithms and structures related to reading compartment mesh.">CmaUtils</a></b> library serves as the interface between <b>CMtool</b> and <b>Kokkos</b>. While <b>CMtool</b> provides lightweight data accessors, it is not optimized for parallel simulation. Many operations require reading flow data efficiently in a parallel context—this is where <b><a class="el" href="namespaceCmaUtils.html" title="Namespace to handle algorithms and structures related to reading compartment mesh.">CmaUtils</a></b> bridges the gap.</p>
<p>The library wraps <b>CMtool</b> and provides an abstraction layer over <b>Kokkos</b> to handle data reading and processing from flow maps within the simulation. This design ensures that simulation logic remains clean and focused on computations, while <b><a class="el" href="namespaceCmaUtils.html" title="Namespace to handle algorithms and structures related to reading compartment mesh.">CmaUtils</a></b> manages the complexity of data handling.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Compartment Operations</h3>
<p>Two main operations have to be performed to CMtool Rawdata in order to used them in simulation kernels.</p><ul>
<li>Construct a transition matrix based on in/out flow in each compartment</li>
<li>Get the cumulative probabilty destination per compartment</li>
</ul>
<p>This operations has been already studied in <a class="el" href="citelist.html#CITEREF_morchain_dynamic_2024">[5]</a> </p>
<h4 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
Transition Matrix</h4>
<p>One can reformulate the mass balance over a scalar field y governed by compartmental flow velocities into matrix form. For each compartment ii, the differential mass balance reads:   </p><p class="formulaDsp">
\[    \frac{dV_{i}y_{i}}{dt}=\sum_{j}y_{j}F(j,i)-y_{i}\sum_{j}y_{j}F(i,j)
\]
</p>
<p> Into   </p><p class="formulaDsp">
\[    \frac{dYV}{dt}=YM
\]
</p>
<p>Implemented in <a class="el" href="namespaceCmaUtils.html#a66366f852348c9e73718973e83e243f5">get_transition_matrix</a>, this function construct the M matrix.</p>
<p>Algorithmic Notes:</p>
<p>The implemented method employs a straightforward sparse matrix assembly via triplet lists:</p><ul>
<li>Off-diagonal terms are populated directly from the flow matrix F(i,j).</li>
<li>Diagonal terms are computed as the negative sum of outbound flows from each compartment, ensuring local mass conservation. This structure yields a well-posed linear operator driving the Eulerian scalar transpors. For discrete stochastic transport, only the diagonal is used and extract with <a class="el" href="namespaceCmaUtils.html#a62072fff78d8de117e133499f87a2a0c">this function</a></li>
</ul>
<h4 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
Cumulative probability</h4>
<p>This step is performed <a class="el" href="namespaceCmaUtils.html#a9aff69bdff3b52945f2be00f4e25846d">here</a>. The result is important to decide where the discrete particles moves.</p>
<p>The aim is to construct of discrete CDF to have to probability to go in a specific compartment knowning that the cell leaves a compartment. Let L the event to leave current compartment i, and let \(I_{j}\) the event to go the compartment i we have for each neighbors \(P(I_{j}|L)\).</p>
<p>This function construct the CDF using the fact that </p><p class="formulaDsp">
\[P(I_{j}|L)=\frac{F(i,j)}{\sum_{k} F(i,k)}\]
</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
FlowMapTransitionner</h3>
<p>Additionally, <b><a class="el" href="namespaceCmaUtils.html" title="Namespace to handle algorithms and structures related to reading compartment mesh.">CmaUtils</a></b> implements the FlowMapTransitionner—an abstraction designed for managing flow map transitions during the simulation. This component provides seamless access to the correct flow map based on the simulation time, abstracting away the details of data formats and file I/O. The transtionner supports flexible behaviors, such as:</p><ul>
<li>Switching to the next flow map after a set time interval.</li>
<li>Looping over available flow maps.</li>
<li>Implementing caching mechanisms for improved performance.</li>
<li>Interpolation between flowmaps. This flexibility ensures efficient and accurate simulation of field evolution over time.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Move kernel</h2>
<p>This operations has been already studied in <a class="el" href="citelist.html#CITEREF_morchain_dynamic_2024">[5]</a> and implementation is <a class="el" href="structSimulation_1_1KernelInline_1_1MoveInfo.html">here</a>.</p>
<p>This kernel performs the following steps:</p><ul>
<li>Compute the probability of leaving the current compartment based on the liquid volume, diagonal transition rate, and time step.</li>
<li>If the particle moves, draw a random number to select the next compartment using the cumulative transition probabilities.</li>
<li>Find the neighbor using cumulative probability using a random number.</li>
<li>Move the particle to the selected compartment; otherwise, it stays in the current one.</li>
</ul>
<p>The probability of leaving the current compartment follows a discrete Poisson law, where the parameter is the compartment's mean residence time.   </p><p class="formulaDsp">
\[    p_{out} = 1 − \exp(-\frac{\Delta t}{\tau})
\]
</p>
<p> Inverse sampling is used to draw from the discrete Poisson law, allowing a no-branching algorithm. The probability of leaving the compartment is <a class="el" href="namespaceSimulation_1_1KernelInline.html#a648521674ead158dd3776a946da6722a">implemented</a> using the regular logarithmic function. For small simulation time steps compared to the mean residence time, approximations may also be applied.</p>
<p>The leaving condition is given by:        </p><p class="formulaDsp">
\[\left\{
\begin{array}{l}
u \sim \mathcal{U}(0, 1) \\
\Delta t \cdot F &gt; -\ln(u) \cdot V
\end{array}
\right.
\]
</p>
<p>where:</p>
<ul>
<li>\(u\) is a uniform random number in \((0, 1)\),</li>
<li>\(\Delta t\) is the simulation time step,</li>
<li>\(F\) is the leaving flow rate,</li>
<li>\(V\) is the liquid volume of the compartment.</li>
</ul>
<p>This Poisson law formalism, based on the cumulative distribution function (CDF) of the leaving probability, is useful because it doesn't depend on the spatial structure or the number of neighboring compartments. It works the same whether a compartment has one neighbor or many. Leaving the reactor is, therefore, treated like moving to any other compartment.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Leaving reactor</h3>
<p>At each time step, a particle can exit the system through a leaving flow. The total flow out of a compartment is defined as: \(F=F_{circulation}+F_{out}\). Where \(F=F_{circulation}\) comes from transition matrix and flowmap and \(F=F_{out}\)</p>
<p>The probability of leaving the reactor is computed using the same inverse sampling method from the exponential (Poisson) law, replacing the internal flow with the specific flow leaving the reactor. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
